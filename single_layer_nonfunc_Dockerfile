# Unfortunately, BIDS Apps and examples are OLD!
# bids/example is built on Ubuntu 14.04 LTS
# This makes installing another python version tricky.
# See below for standardized workaround, including extra
# packages for pip to work inside the flypy env.
FROM bids/example

ENV FLYWHEEL="/flywheel/v0"
WORKDIR ${FLYWHEEL}

# Install build dependencies
RUN apt-get update && \
    apt-get install -y  \
    curl \
    build-essential \
    libssl-dev \
    zlib1g-dev \
    libncurses5-dev \
    libncursesw5-dev \
    libreadline-dev \
    libsqlite3-dev \
    libgdbm-dev \
    libdb5.3-dev \
    libbz2-dev \
    libexpat1-dev \
    liblzma-dev \
    libffi-dev \
    uuid-dev \
    && \
    apt-get clean

# Download Python 3.9 source code
RUN cd /tmp && \
    curl -O https://www.python.org/ftp/python/3.9.12/Python-3.9.12.tgz && \
    tar xzf Python-3.9.12.tgz

# Build and install Python 3.9
RUN cd /tmp/Python-3.9.12 && \
    ./configure && \
    make && \
    make install
RUN python3.9 -m venv /opt/venv/flypy
ENV PATH="/opt/venv/flypy/bin:$PATH"

# Install system dependencies
RUN apt-get update && \
    apt-get upgrade -y && \
    apt-get install --no-install-recommends -y \
        git \
        zip \
        nodejs \
        tree && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Copy and install 'fw_base' Python dependencies
COPY ./requirements.txt ${FLYWHEEL}/requirements.txt
RUN /opt/venv/flypy/bin/pip install --trusted-host pypi.org --trusted-host pypi.python.org --trusted-host files.pythonhosted.org pip setuptools
RUN /opt/venv/flypy/bin/pip install --no-cache-dir -r ${FLYWHEEL}/requirements.txt

# Copy project files
COPY ./ $FLYWHEEL/

# Set the entrypoint
RUN chmod a+x $FLYWHEEL/run.py
ENTRYPOINT ["/opt/venv/flypy/bin/python", "/flywheel/v0/run.py"]